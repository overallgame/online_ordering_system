import { AvatarUploadService } from '../service/AvatarUploadService';

/**
 * å¤´åƒé€‰æ‹©å¯¹è¯æ¡†ç»„ä»¶
 */
@Component
export struct AvatarSelectDialog {
  @State isUploading: boolean = false;
  onAvatarSelected?: (avatarUri: string) => void;
  onCancel?: () => void;

  private avatarUploadService: AvatarUploadService = AvatarUploadService.getInstance();


  /**
   * ä»Žç›¸å†Œé€‰æ‹©
   */
  async selectFromGallery() {
    try {
      this.isUploading = true;
      const avatarUri = await this.avatarUploadService.selectAndUploadAvatar();
      if (avatarUri) {
        this.onAvatarSelected?.(avatarUri);
      }
    } catch (error) {
      console.error('é€‰æ‹©å¤´åƒå¤±è´¥:', error);
    } finally {
      this.isUploading = false;
    }
  }

  /**
   * æ‹ç…§
   */
  async takePhoto() {
    try {
      this.isUploading = true;
      const avatarUri = await this.avatarUploadService.takePhoto();
      if (avatarUri) {
        this.onAvatarSelected?.(avatarUri);
      }
    } catch (error) {
      console.error('æ‹ç…§å¤±è´¥:', error);
    } finally {
      this.isUploading = false;
    }
  }

  /**
   * å–æ¶ˆé€‰æ‹©
   */
  cancel() {
    this.onCancel?.();
  }

  build() {
    Stack() {
        // åŠé€æ˜ŽèƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#000000')
          .opacity(0.5)
          .onClick(() => this.cancel())

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          // æ ‡é¢˜
          Text('é€‰æ‹©å¤´åƒ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#000000')
            .margin({ bottom: 20 })

          // é€‰é¡¹æŒ‰é’®
          Column() {
            // ä»Žç›¸å†Œé€‰æ‹©
            Row() {
              Text('ðŸ“·')
                .fontSize(24)
                .margin({ right: 12 })
              
              Text('ä»Žç›¸å†Œé€‰æ‹©')
                .fontSize(16)
                .fontColor('#000000')
                .layoutWeight(1)
              
              if (this.isUploading) {
                LoadingProgress()
                  .width(20)
                  .height(20)
              }
            }
            .width('100%')
            .height(50)
            .padding({ left: 16, right: 16 })
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
            .onClick(() => this.selectFromGallery())
            .enabled(!this.isUploading)

            // æ‹ç…§
            Row() {
              Text('ðŸ“¸')
                .fontSize(24)
                .margin({ right: 12 })
              
              Text('æ‹ç…§')
                .fontSize(16)
                .fontColor('#000000')
                .layoutWeight(1)
            }
            .width('100%')
            .height(50)
            .padding({ left: 16, right: 16 })
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
            .margin({ top: 12 })
            .onClick(() => this.takePhoto())
            .enabled(!this.isUploading)

            // å–æ¶ˆæŒ‰é’®
            Text('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
              .width('100%')
              .height(50)
              .textAlign(TextAlign.Center)
              .margin({ top: 20 })
              .onClick(() => this.cancel())
          }
          .width('100%')
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 10, color: '#00000020', offsetX: 0, offsetY: 4 })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1000)
  }
}
