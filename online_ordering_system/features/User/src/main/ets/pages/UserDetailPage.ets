import { UserViewModel } from '../viewmodel/UserViewModel';
import { User, UserPreferences, AppDataManager } from 'common';
import { ToastComponent } from '../components/ToastComponent';
import { InfoItem } from '../view/InfoItemView';
import { AvatarUploadService } from '../service/AvatarUploadService';
@Component
export struct UserDetailPage {
  @Link userViewModel: UserViewModel;
  @Consume('navStack') navStack: NavPathStack;
  @State isEditing: boolean = false;
  @State editUser: User = new User();
  @State isAvatarDialogVisible: boolean = false;

  aboutToAppear() {
    this.loadUserInfo();
  }

  async loadUserInfo() {
    const currentUser = this.userViewModel.user;
    if (currentUser) {
      // ç”±äºUserViewModelç°åœ¨ä½¿ç”¨ç›‘å¬å™¨ï¼Œè¿™é‡Œåªéœ€è¦æ›´æ–°editUser
      this.editUser = this.userViewModel.copyUser(currentUser);
      console.log("testï¼š"+this.editUser.sex);
      console.log("testï¼š"+this.editUser.username);
    } else {
      console.warn('å½“å‰æ²¡æœ‰ç™»å½•ç”¨æˆ·');
    }
  }

  build() {
    NavDestination() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.buildTopBar()
        
        // ä¸ªäººä¿¡æ¯è¯¦æƒ…
        Scroll(){
          this.buildUserDetailContent()
        }

        // å¤´åƒé€‰æ‹©å¯¹è¯æ¡†
        if (this.isAvatarDialogVisible) {
          this.buildAvatarSelectDialog()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .title('ä¸ªäººä¿¡æ¯')
    .hideTitleBar(true)
  }

  @Builder
  buildTopBar() {
    Row() {
      Image($r('app.media.back'))
        .width(24)
        .height(24)
        .onClick(() => {
          this.navStack.pop();
        })
      
      Text('ä¸ªäººä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#000000')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      if (this.isEditing) {
        Text('ä¿å­˜')
          .fontSize(16)
          .fontColor('#007AFF')
          .onClick(() => {
            this.saveUserInfo();
          })
      } else {
        Text('ç¼–è¾‘')
          .fontSize(16)
          .fontColor('#007AFF')
          .onClick(() => {
            this.startEdit();
          })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
  }

  @Builder
  buildUserDetailContent() {
    Column() {
      // åŸºæœ¬ä¿¡æ¯
      this.buildBasicInfoSection()
      
      // è”ç³»æ–¹å¼
      this.buildContactSection()
      
      // å…¶ä»–ä¿¡æ¯
      this.buildOtherInfoSection()
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildBasicInfoSection() {
    Column() {
      Text('åŸºæœ¬ä¿¡æ¯')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#000000')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      Row() {
        Text("å¤´åƒ")
          .fontSize(14)
          .fontColor('#666666')
          .width(80)
          .textAlign(TextAlign.Start)
        Column() {
          Image(this.editUser.avatar ? this.editUser.avatar : $r('app.media.default_avatar'))
            .width(60)
            .height(60)
            .borderRadius(50)
            .border({ width: 3, color: '#FFFFFF' })
            .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 })
            .objectFit(ImageFit.Cover)
            .margin({right:10})
          if(this.isEditing)
          {
            Text('ç‚¹å‡»æ›´æ¢å¤´åƒ')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 8 })
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.End)
        .onClick(() => {
          if (this.isEditing) {
            this.selectAvatar();
          }
        })
      }


      InfoItem({
        label: 'ç”¨æˆ·å',
        value: this.editUser?.username || 'æœªè®¾ç½®',
        onChange: (value: string) => {
          this.editUser.username = value;
        },
        isEditing: this.isEditing,
        readonly:false
      })

      // æ€§åˆ«é€‰æ‹©
      this.buildSexSelector()

    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .backgroundColor('#FFFFFF')
    .margin({ top: 16, left: 16, right: 16 })
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildContactSection() {
    Column() {
      Text('è”ç³»æ–¹å¼')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#000000')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      InfoItem({
        label: 'æ‰‹æœºå·',
        value: this.editUser?.phone || 'æœªè®¾ç½®',
        onChange: (value: string) => {
          this.editUser.phone = value;
        },
        isEditing: this.isEditing,
        readonly:false
      })

      InfoItem({
        label: 'é‚®ç®±',
        value: this.editUser?.email || 'æœªè®¾ç½®',
        onChange: (value: string) => {
          this.editUser.email = value;
        },
        isEditing: this.isEditing,
        readonly:false
      })



    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .backgroundColor('#FFFFFF')
    .margin({ top: 16, left: 16, right: 16 })
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildOtherInfoSection() {
    Column() {
      Text('å…¶ä»–ä¿¡æ¯')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#000000')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      InfoItem({
        label: 'åœ°å€',
        value: this.editUser?.address || 'æœªè®¾ç½®',
        onChange: (value: string) => {
          this.editUser.address = value;
        },
        isEditing: this.isEditing,
        readonly:false
      })


      InfoItem({
        label: 'ç™»å½•æ—¶é—´',
        value: this.formatDate(this.editUser?.lastLoginTime || 0) || 'æœªè®¾ç½®',
        onChange: null,
        isEditing: this.isEditing,
        readonly:false
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .backgroundColor('#FFFFFF')
    .margin({ top: 16, left: 16, right: 16, bottom: 20 })
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildSexSelector() {
    Row() {
      Text('æ€§åˆ«')
        .fontSize(14)
        .fontColor('#666666')
        .width(80)
        .textAlign(TextAlign.Start)
      
      if (this.isEditing) {
        Row() {
          Button('ç”·')
            .fontSize(14)
            .fontColor(this.editUser.sex === 'ç”·' ? '#FFFFFF' : '#007AFF')
            .backgroundColor(this.editUser.sex === 'ç”·' ? '#007AFF' : '#F0F0F0')
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .onClick(() => {
              this.editUser.sex = 'ç”·';
            })
          
          Button('å¥³')
            .fontSize(14)
            .fontColor(this.editUser.sex === 'å¥³' ? '#FFFFFF' : '#007AFF')
            .backgroundColor(this.editUser.sex === 'å¥³' ? '#007AFF' : '#F0F0F0')
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .margin({ left: 12 })
            .onClick(() => {
              this.editUser.sex = 'å¥³';
            })
          
          Button('æœªçŸ¥')
            .fontSize(14)
            .fontColor(this.editUser.sex === 'æœªçŸ¥' ? '#FFFFFF' : '#007AFF')
            .backgroundColor(this.editUser.sex === 'æœªçŸ¥' ? '#007AFF' : '#F0F0F0')
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .margin({ left: 12 })
            .onClick(() => {
              this.editUser.sex = 'æœªçŸ¥';
            })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.End)
      } else {
        Text(this.editUser.sex? this.editUser.sex:"æœªè®¾ç½®")
          .fontSize(16)
          .fontColor('#000000')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
          .margin({right:20})
      }
    }
    .width('100%')
    .height(50)
    .alignItems(VerticalAlign.Center)
    .margin({ bottom: 16 })
  }

  @Builder
  buildInfoItem(label: string, value: string, onChange?: (value: string) => void, readonly: boolean = false) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#666666')
        .width(80)
        .textAlign(TextAlign.Start)
      
      if (this.isEditing && !readonly && onChange) {
        TextInput({ placeholder: `è¯·è¾“å…¥${label}` })
          .onChange(onChange)
          .fontSize(16)
          .fontColor('#000000')
          .backgroundColor('#F8F8F8')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .layoutWeight(1)
      } else {
        Text(value)
          .fontSize(16)
          .fontColor('#000000')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }
    }
    .width('100%')
    .height(50)
    .alignItems(VerticalAlign.Center)
    .margin({ bottom: 16 })
  }

  // ç¼–è¾‘ç›¸å…³æ–¹æ³•
  startEdit() {
    if (!this.userViewModel.user) {
      console.error('æ— æ³•å¼€å§‹ç¼–è¾‘ï¼šç”¨æˆ·ä¿¡æ¯ä¸ºç©º');
      this.showToast('ç”¨æˆ·ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
      return;
    }
    
    this.isEditing = true;
    this.editUser = this.userViewModel.copyUser(this.userViewModel.user);
  }


  async saveUserInfo() {
    try {
      // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
      this.showToast('æ­£åœ¨ä¿å­˜...');
      
      // ä½¿ç”¨UserViewModelçš„updateUserProfileæ–¹æ³•ï¼Œè¿™ä¼šåŒæ—¶æ›´æ–°æœ¬åœ°å’ŒåŒæ­¥åˆ°åç«¯
      const success = await this.userViewModel.updateUserProfile(this.editUser);
      
      if (success) {
        this.isEditing = false;
        this.showToast('ä¿å­˜æˆåŠŸ');
      } else {
        this.showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (error) {
      console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      this.showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  selectAvatar() {
    this.isAvatarDialogVisible = true;
  }

  /**
   * æ„å»ºå¤´åƒé€‰æ‹©å¯¹è¯æ¡†
   */
  @Builder
  buildAvatarSelectDialog() {
    Stack() {
      // åŠé€æ˜èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.isAvatarDialogVisible = false;
        })

      // åº•éƒ¨å¯¹è¯æ¡†
      Column() {
        // æ ‡é¢˜
        Text('é€‰æ‹©å¤´åƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#000000')
          .margin({ bottom: 20 })

        // é€‰é¡¹æŒ‰é’®
        Column() {
          // ä»ç›¸å†Œé€‰æ‹©
          Row() {
            Text('ğŸ“·')
              .fontSize(24)
              .margin({ right: 12 })
            
            Text('ä»ç›¸å†Œé€‰æ‹©')
              .fontSize(16)
              .fontColor('#000000')
              .layoutWeight(1)
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .onClick(() => {
            this.selectFromGallery();
          })

          // æ‹ç…§
          Row() {
            Text('ğŸ“¸')
              .fontSize(24)
              .margin({ right: 12 })
            
            Text('æ‹ç…§')
              .fontSize(16)
              .fontColor('#000000')
              .layoutWeight(1)
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .margin({ top: 12 })
          .onClick(() => {
            this.takePhoto();
          })

          // å–æ¶ˆæŒ‰é’®
          Text('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#666666')
            .width('100%')
            .height(50)
            .textAlign(TextAlign.Center)
            .margin({ top: 20 })
            .onClick(() => {
              this.isAvatarDialogVisible = false;
            })
        }
        .width('100%')
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 12, topRight: 12 })
      .position({ x: 0, y: '60%' })
      .shadow({ radius: 10, color: '#00000020', offsetX: 0, offsetY: -4 })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  /**
   * ä»ç›¸å†Œé€‰æ‹©å¤´åƒ
   */
  async selectFromGallery() {
    try {
      const avatarUploadService = AvatarUploadService.getInstance();
      const avatarUri = await avatarUploadService.selectAndUploadAvatar();
      
      if (avatarUri) {
        this.editUser.avatar = avatarUri;
        this.isAvatarDialogVisible = false;
        this.showToast('å¤´åƒå·²æ›´æ–°');
      }
    } catch (error) {
      console.error('é€‰æ‹©å¤´åƒå¤±è´¥:', error);
      this.showToast('é€‰æ‹©å¤´åƒå¤±è´¥');
    }
  }

  /**
   * æ‹ç…§é€‰æ‹©å¤´åƒ
   */
  async takePhoto() {
    try {
      const avatarUploadService = AvatarUploadService.getInstance();
      const avatarUri = await avatarUploadService.takePhoto();
      
      if (avatarUri) {
        this.editUser.avatar = avatarUri;
        this.isAvatarDialogVisible = false;
        this.showToast('å¤´åƒå·²æ›´æ–°');
      } else {
        this.showToast('æ‹ç…§åŠŸèƒ½æš‚æœªå®ç°');
      }
    } catch (error) {
      console.error('æ‹ç…§å¤±è´¥:', error);
      this.showToast('æ‹ç…§å¤±è´¥');
    }
  }

  formatDate(timestamp: number): string {
    if (timestamp === 0) {
      return 'æœªè®¾ç½®';
    }
    const date = new Date(timestamp);
    return date.toLocaleDateString('zh-CN');
  }

  showToast(message: string) {
    ToastComponent.getInstance().show(message);
  }


  // å¤åˆ¶ç”¨æˆ·å¯¹è±¡çš„æ–¹æ³•

}
