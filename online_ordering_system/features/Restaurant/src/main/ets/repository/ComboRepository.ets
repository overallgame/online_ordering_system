import { Combo, ComboDish, Dish } from 'common';
import { Result, ok, err } from '../util/Result';
import { ApiClient, ApiEndpoints } from 'common';
import { SetmealApiResponse, SetmealDishApiResponse } from '../model/ComboApiModels';
import { ComboDataConverter } from '../util/ComboDataConverter';

export interface CombosPage {
  items: Array<Combo>;
  hasMore: boolean;
}

export class ComboRepository {
  private apiClient: ApiClient = ApiClient.getInstance();

  // æ ¹æ®åˆ†ç±»IDè·å–å¥—é¤åˆ—è¡¨
  async fetchCombosByCategoryId(categoryId: number): Promise<Result<Array<Combo>>> {
    try {
      const response = await this.apiClient.get<SetmealApiResponse>(`${ApiEndpoints.SETMEAL_LIST}?categoryId=${categoryId}`);

      if (response.success && response.data && response.data.data) {
        const combos: Array<Combo> = ComboDataConverter.convertSetmealVOListToComboList(response.data.data);
        return ok<Array<Combo>>(combos);
      } else {
        console.warn('å¥—é¤APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', response.error);
        return ok<Array<Combo>>(this.getMockCombosByCategory(categoryId));
      }
    } catch (e) {
      console.error('è·å–å¥—é¤åˆ—è¡¨å¤±è´¥:', e);
      return ok<Array<Combo>>(this.getMockCombosByCategory(categoryId));
    }
  }

  // æ ¹æ®å¥—é¤IDè·å–å¥—é¤èœå“åˆ—è¡¨
  async fetchComboDishesByComboId(comboId: string): Promise<Result<Array<ComboDish>>> {
    try {
      const response = await this.apiClient.get<SetmealDishApiResponse>(`${ApiEndpoints.SETMEAL_DISH_LIST}/${comboId}`);

      if (response.success && response.data && response.data.data) {
        const comboDishes: Array<ComboDish> = ComboDataConverter.convertDishItemVOListToComboDishList(response.data.data);
        return ok<Array<ComboDish>>(comboDishes);
      } else {
        console.warn('å¥—é¤èœå“APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', response.error);
        return ok<Array<ComboDish>>(this.getMockComboDishes(comboId));
      }
    } catch (e) {
      console.error('è·å–å¥—é¤èœå“åˆ—è¡¨å¤±è´¥:', e);
      return ok<Array<ComboDish>>(this.getMockComboDishes(comboId));
    }
  }

  // æ ¹æ®åˆ†ç±»IDè·å–æ¨¡æ‹Ÿå¥—é¤æ•°æ®ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
  private getMockCombosByCategory(categoryId: number): Array<Combo> {
    const mockCombos: Array<Combo> = [
      {
        comboId: '1',
        name: 'ç»å…¸åŒäººå¥—é¤',
        description: 'ç²¾é€‰æ‹›ç‰Œèœ+æ±¤å“+ä¸»é£Ÿï¼Œé€‚åˆä¸¤äººäº«ç”¨',
        icon: 'ğŸ½ï¸',
        image: 'common/images/combo1.png',
        price: 88,
        originalPrice: 120,
        discount: 32,
        dishes: [],
        isAvailable: true,
        tags: ['çƒ­é”€', 'åŒäºº'],
        rating: 4.8,
        reviewCount: 156,
        preparationTime: 25,
        category: 'ç»å…¸å¥—é¤',
        sortOrder: 1
      },
      {
        comboId: '2',
        name: 'å®¶åº­å››äººå¥—é¤',
        description: 'ä¸°å¯Œèœå“ç»„åˆï¼Œæ»¡è¶³å…¨å®¶å£å‘³éœ€æ±‚',
        icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
        image: 'common/images/combo2.png',
        price: 168,
        originalPrice: 220,
        discount: 52,
        dishes: [],
        isAvailable: true,
        tags: ['å®¶åº­', 'å®æƒ '],
        rating: 4.6,
        reviewCount: 89,
        preparationTime: 30,
        category: 'ç‰¹è‰²å¥—é¤',
        sortOrder: 2
      },
      {
        comboId: '3',
        name: 'å•†åŠ¡å¥—é¤',
        description: 'ç²¾è‡´èœå“æ­é…ï¼Œé€‚åˆå•†åŠ¡å®´è¯·',
        icon: 'ğŸ’¼',
        image: 'common/images/combo3.png',
        price: 288,
        originalPrice: 350,
        discount: 62,
        dishes: [],
        isAvailable: true,
        tags: ['å•†åŠ¡', 'ç²¾è‡´'],
        rating: 4.9,
        reviewCount: 45,
        preparationTime: 35,
        category: 'è¥å…»å¥—é¤',
        sortOrder: 3
      },
      {
        comboId: '4',
        name: 'æƒ…ä¾£æµªæ¼«å¥—é¤',
        description: 'æµªæ¼«æ°›å›´èœå“ï¼Œé€‚åˆæƒ…ä¾£çº¦ä¼š',
        icon: 'ğŸ’•',
        image: 'common/images/combo4.png',
        price: 128,
        originalPrice: 160,
        discount: 32,
        dishes: [],
        isAvailable: true,
        tags: ['æµªæ¼«', 'æƒ…ä¾£'],
        rating: 4.7,
        reviewCount: 78,
        preparationTime: 20,
        category: 'ä¼˜æƒ å¥—é¤',
        sortOrder: 4
      }
    ];

    // æ ¹æ®åˆ†ç±»IDè¿”å›ä¸åŒçš„å¥—é¤
    switch (categoryId) {
      case 201: // ç»å…¸å¥—é¤
        return mockCombos.filter(combo => combo.category === 'ç»å…¸å¥—é¤');
      case 202: // ç‰¹è‰²å¥—é¤
        return mockCombos.filter(combo => combo.category === 'ç‰¹è‰²å¥—é¤');
      case 203: // è¥å…»å¥—é¤
        return mockCombos.filter(combo => combo.category === 'è¥å…»å¥—é¤');
      case 204: // ä¼˜æƒ å¥—é¤
        return mockCombos.filter(combo => combo.category === 'ä¼˜æƒ å¥—é¤');
      default:
        return mockCombos;
    }
  }

  // è·å–æ¨¡æ‹Ÿå¥—é¤èœå“æ•°æ®ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
  private getMockComboDishes(comboId: string): Array<ComboDish> {
    // æ ¹æ®å¥—é¤IDè¿”å›ä¸åŒçš„æ¨¡æ‹Ÿèœå“
    const mockDishes: Array<ComboDish> = [];
    
    switch (comboId) {
      case '1': // ç»å…¸åŒäººå¥—é¤
        mockDishes.push(this.createMockComboDish('å®«ä¿é¸¡ä¸', 'ç»å…¸å·èœï¼Œé¸¡è‚‰å«©æ»‘ï¼ŒèŠ±ç”Ÿé¦™è„†', 'common/images/dish1.png', 1));
        mockDishes.push(this.createMockComboDish('éº»å©†è±†è…', 'å››å·ä¼ ç»Ÿåèœï¼Œè±†è…å«©æ»‘ï¼Œéº»è¾£é²œé¦™', 'common/images/dish2.png', 1));
        mockDishes.push(this.createMockComboDish('è¥¿çº¢æŸ¿é¸¡è›‹æ±¤', 'è¥å…»ä¸°å¯Œï¼Œå‘³é“é²œç¾', 'common/images/dish3.png', 1));
        break;
      case '2': // å®¶åº­å››äººå¥—é¤
        mockDishes.push(this.createMockComboDish('å›é”…è‚‰', 'è‚¥è€Œä¸è…»ï¼Œé¦™è¾£å¯å£ï¼Œç»å…¸å·èœ', 'common/images/dish4.png', 1));
        mockDishes.push(this.createMockComboDish('ç³–é†‹é‡Œè„Š', 'å¤–é…¥å†…å«©ï¼Œé…¸ç”œå¯å£ï¼Œè€å°‘çš†å®œ', 'common/images/dish5.png', 1));
        mockDishes.push(this.createMockComboDish('é…¸è¾£åœŸè±†ä¸', 'çˆ½è„†å¯å£ï¼Œé…¸è¾£å¼€èƒƒï¼Œå®¶å¸¸ç¾å‘³', 'common/images/dish6.png', 1));
        mockDishes.push(this.createMockComboDish('è›‹ç‚’é¥­', 'ç²’ç²’åˆ†æ˜ï¼Œé¦™å‘³æµ“éƒ', 'common/images/dish7.png', 1));
        break;
      case '3': // å•†åŠ¡å¥—é¤
        mockDishes.push(this.createMockComboDish('æ‹›ç‰Œæ°´ç…®é±¼', 'é²œå«©é±¼è‚‰ï¼Œéº»è¾£é²œé¦™ï¼Œé…èœä¸°å¯Œ', 'common/images/dish8.png', 1));
        mockDishes.push(this.createMockComboDish('å¤«å¦»è‚ºç‰‡', 'ç»å…¸å·èœï¼Œéº»è¾£çˆ½å£ï¼Œå£æ„Ÿä¸°å¯Œ', 'common/images/dish9.png', 1));
        mockDishes.push(this.createMockComboDish('è’œè“‰è¥¿å…°èŠ±', 'æ¸…çˆ½å¥åº·ï¼Œè’œé¦™æµ“éƒï¼Œè¥å…»ä¸°å¯Œ', 'common/images/dish10.png', 1));
        break;
      case '4': // æƒ…ä¾£æµªæ¼«å¥—é¤
        mockDishes.push(this.createMockComboDish('ç³–é†‹é‡Œè„Š', 'å¤–é…¥å†…å«©ï¼Œé…¸ç”œå¯å£ï¼Œè€å°‘çš†å®œ', 'common/images/dish11.png', 1));
        mockDishes.push(this.createMockComboDish('è’œè“‰è¥¿å…°èŠ±', 'æ¸…çˆ½å¥åº·ï¼Œè’œé¦™æµ“éƒï¼Œè¥å…»ä¸°å¯Œ', 'common/images/dish12.png', 1));
        mockDishes.push(this.createMockComboDish('è¥¿çº¢æŸ¿é¸¡è›‹æ±¤', 'è¥å…»ä¸°å¯Œï¼Œå‘³é“é²œç¾', 'common/images/dish13.png', 1));
        break;
      default:
        // é»˜è®¤å¥—é¤èœå“
        mockDishes.push(this.createMockComboDish('å®«ä¿é¸¡ä¸', 'ç»å…¸å·èœï¼Œé¸¡è‚‰å«©æ»‘ï¼ŒèŠ±ç”Ÿé¦™è„†', 'common/images/dish1.png', 1));
        mockDishes.push(this.createMockComboDish('éº»å©†è±†è…', 'å››å·ä¼ ç»Ÿåèœï¼Œè±†è…å«©æ»‘ï¼Œéº»è¾£é²œé¦™', 'common/images/dish2.png', 1));
    }
    
    return mockDishes;
  }

  // åˆ›å»ºæ¨¡æ‹Ÿå¥—é¤èœå“
  private createMockComboDish(name: string, description: string, image: string, copies: number): ComboDish {
    const comboDish = new ComboDish();
    const dish = new Dish();
    
    dish.dishId = `mock_dish_${name}_${Date.now()}`;
    dish.name = name;
    dish.description = description;
    dish.image = image;
    dish.price = 0; // å¥—é¤èœå“ä¸å•ç‹¬å®šä»·
    dish.isAvailable = true;
    dish.stock = 999;
    dish.tags = ['å¥—é¤èœå“'];
    dish.category = 'å¥—é¤èœå“';
    dish.preparationTime = 15;
    dish.rating = 4.0;
    dish.reviewCount = 0;
    
    comboDish.dish = dish;
    comboDish.quantity = copies;
    comboDish.isRequired = true;
    comboDish.canCustomize = false;
    
    return comboDish;
  }
}