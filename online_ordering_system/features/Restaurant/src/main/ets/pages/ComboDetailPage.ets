import { Combo, ComboDish } from 'common';
import { ComboDetailViewModel } from '../viewModel/ComboDetailViewModel';
import { ComboViewModel } from '../viewModel/ComboViewModel';
import { Review } from 'common';
import { LoadStatus } from '../util/DataState';
import { PageName } from '../util/NavigationTypes';

@Component
export struct ComboDetailPage {
  @Consume('restaurantPathStack') restaurantPathStack: NavPathStack;
  private viewModel: ComboDetailViewModel = new ComboDetailViewModel();
  private comboViewModel: ComboViewModel = new ComboViewModel();
  @State combo?: Combo = undefined;
  @State comboDishes: ComboDish[] = [];
  @State dishesLoading: boolean = false;
  @State dishesError?: string = undefined;
  @State reviews: Review[] = [];
  @State reviewStatus: LoadStatus = LoadStatus.Idle;
  @State reviewError?: string = undefined;
  @State isLoadingMoreReviews: boolean = false;
  @State hasMoreReviews: boolean = false;
  // Êî∂ËóèÁä∂ÊÄÅ
  @State isFavorited: boolean = false;
  private comboId: string = '';

  aboutToAppear() {
    this.combo = this.restaurantPathStack.getParamByName(PageName.COMBO_DETAIL)[0] as Combo;
    if (this.combo) {
      this.comboId = this.combo.comboId;
      this.checkFavoriteStatus();
      this.loadComboDishes();
      this.loadReviews();
    }
  }

  // Âä†ËΩΩÂ•óÈ§êËèúÂìÅ‰ø°ÊÅØ
  private async loadComboDishes() {
    if (!this.comboId) return;
    
    this.dishesLoading = true;
    this.dishesError = undefined;
    
    try {
      this.comboDishes = await this.comboViewModel.loadComboDishesByComboId(this.comboId);
      console.log('ComboDetailPage: Âä†ËΩΩÂ•óÈ§êËèúÂìÅÊàêÂäüÔºåËèúÂìÅÊï∞Èáè:', this.comboDishes.length);
    } catch (error) {
      console.error('ComboDetailPage: Âä†ËΩΩÂ•óÈ§êËèúÂìÅÂ§±Ë¥•:', error);
      this.dishesError = 'Âä†ËΩΩËèúÂìÅ‰ø°ÊÅØÂ§±Ë¥•';
    } finally {
      this.dishesLoading = false;
    }
  }

  private async loadReviews() {
    this.reviewStatus = LoadStatus.Loading;
    this.reviewError = undefined;
    await this.viewModel.loadReviews(this.comboId);
    this.reviews = this.viewModel.reviewsState.data;
    this.reviewStatus = this.viewModel.reviewsState.status;
    this.reviewError = this.viewModel.reviewsState.error;
    this.hasMoreReviews = this.viewModel.hasMoreReviews;
  }

  private async onLoadMoreReviews() {
    if (this.isLoadingMoreReviews || !this.hasMoreReviews) {
      return;
    }
    this.isLoadingMoreReviews = true;
    await this.viewModel.loadMoreReviews(this.comboId);
    this.reviews = this.viewModel.reviewsState.data;
    this.hasMoreReviews = this.viewModel.hasMoreReviews;
    this.isLoadingMoreReviews = false;
  }

  // Ê£ÄÊü•Êî∂ËóèÁä∂ÊÄÅ
  private checkFavoriteStatus(): void {
    // TODO: ‰ªéÊú¨Âú∞Â≠òÂÇ®ÊàñÂêéÁ´ØÊ£ÄÊü•Êî∂ËóèÁä∂ÊÄÅ
    // ËøôÈáåÂÖàÊ®°Êãü‰∏Ä‰∏™Áä∂ÊÄÅ
    this.isFavorited = false;
  }

  // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
  private toggleFavorite(): void {
    this.isFavorited = !this.isFavorited;
    // TODO: ‰øùÂ≠òÊî∂ËóèÁä∂ÊÄÅÂà∞Êú¨Âú∞Â≠òÂÇ®ÊàñÂêåÊ≠•Âà∞ÂêéÁ´Ø
    console.log(`Combo ${this.combo?.name} ${this.isFavorited ? 'Êî∂Ëóè' : 'ÂèñÊ∂àÊî∂Ëóè'}`);
  }

  build() {
    NavDestination() {
      Scroll() {
        Column() {
          // Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÂ•óÈ§êÂõæÁâáÂíåËøîÂõûÊåâÈíÆ
          this.buildComboImage()

          // Á¨¨‰∫åÈÉ®ÂàÜÔºöÂ•óÈ§ê‰ø°ÊÅØ
          this.buildComboInfo()

          // Á¨¨‰∏âÈÉ®ÂàÜÔºöÂ•óÈ§êÊèèËø∞
          this.buildDescription()

          // Á¨¨ÂõõÈÉ®ÂàÜÔºöËØÑËÆ∫ÂàóË°®
          this.buildReviewList()
        }
        .width('100%')
      }
      .scrollBar(BarState.Auto)
      .width('100%')
      .height('100%')
      .backgroundColor($r('sys.color.comp_background_list_card'))
    }
    .hideTitleBar(true)
  }

  // Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÂ•óÈ§êÂõæÁâáÂíåËøîÂõûÊåâÈíÆ
  @Builder
  buildComboImage() {
    Stack({ alignContent: Alignment.TopStart }) {
      if (this.combo) {
        Image(this.combo.image)
          .width('100%')
          .height(300)
          .objectFit(ImageFit.Cover)
          .alt($r('app.media.zwt'))
      }

      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .objectFit(ImageFit.Contain)
      }
      .width(40)
      .height(40)
      .backgroundColor('rgba(0, 0, 0, 0.3)')
      .borderRadius(20)
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .margin({ top: 16, left: 16 })
      .onClick(() => {
        this.restaurantPathStack.pop();
      })
    }
    .width('100%')
    .height(300)
  }

  // Á¨¨‰∫åÈÉ®ÂàÜÔºöÂ•óÈ§ê‰ø°ÊÅØ
  @Builder
  buildComboInfo() {
    if (this.combo) {
      Column() {
        Row() {
          Column() {
            Text(this.combo.name)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 8 })

            Row() {
              Text('‚òÖ')
                .fontSize(14)
                .fontColor('#FFC107')
              Text(`${this.combo.rating}`)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ left: 4, right: 12 })

              ForEach(this.combo.tags, (tag: string) => {
                Text(tag)
                  .fontSize(10)
                  .fontColor('#FF6B6B')
                  .backgroundColor('#FFF0F0')
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .borderRadius(8)
                  .margin({ right: 4 })
              })
            }
            .margin({ bottom: 12 })

            Row() {
              Text(`Ôø•${this.combo.price}`)
                .fontSize(24)
                .fontColor('#FF6B6B')
                .fontWeight(FontWeight.Bold)

              if (this.combo.originalPrice && this.combo.originalPrice > this.combo.price) {
                Text(`Ôø•${this.combo.originalPrice}`)
                  .fontSize(14)
                  .fontColor('#999999')
                  .decoration({ type: TextDecorationType.LineThrough })
                  .margin({ left: 8 })
              }
            }
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          // Êî∂ËóèÊåâÈíÆ
          Row() {
            Text(this.isFavorited ? '‚ù§Ô∏è' : 'ü§ç')
              .fontSize(20)
            }
            .width(40)
            .height(40)
            .backgroundColor(this.isFavorited ? '#FFF0F0' : '#F8F8F8')
            .borderRadius(20)
            .justifyContent(FlexAlign.Center)
            .alignItems(VerticalAlign.Center)
            .onClick(() => {
              this.toggleFavorite();
            })
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .margin({ bottom: 12 })
    }
  }

  // Á¨¨‰∏âÈÉ®ÂàÜÔºöÂ•óÈ§êÊèèËø∞ÂíåËèúÂìÅÂàóË°®
  @Builder
  buildDescription() {
    Column() {
      // Â•óÈ§ê‰ªãÁªç
      if (this.combo && this.combo.description) {
        Column() {
          Text('Â•óÈ§ê‰ªãÁªç')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 12 })

          Text(this.combo.description)
            .fontSize(14)
            .fontColor('#666666')
            .lineHeight(22)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .margin({ bottom: 16 })
      }

      // Â•óÈ§êËèúÂìÅÂàóË°®
      Column() {
        Text('Â•óÈ§êËèúÂìÅ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 12 })

        if (this.dishesLoading) {
          Row() {
            LoadingProgress()
              .width(20)
              .height(20)
            Text(' Ê≠£Âú®Âä†ËΩΩËèúÂìÅ‰ø°ÊÅØ...')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .height(60)
          .justifyContent(FlexAlign.Center)
        } else if (this.dishesError) {
          Column() {
            Text(this.dishesError)
              .fontSize(14)
              .fontColor('#FF6B6B')
            Button('ÈáçËØï')
              .fontSize(12)
              .onClick(() => {
                this.loadComboDishes();
              })
              .margin({ top: 8 })
          }
          .width('100%')
          .height(60)
          .justifyContent(FlexAlign.Center)
        } else if (this.comboDishes.length === 0) {
          Text('ÊöÇÊó†ËèúÂìÅ‰ø°ÊÅØ')
            .fontSize(14)
            .fontColor('#999999')
            .width('100%')
            .height(60)
            .textAlign(TextAlign.Center)
        } else {
          Column() {
            ForEach(this.comboDishes, (comboDish: ComboDish, index: number) => {
              this.buildDishItem(comboDish, index)
            })
          }
          .width('100%')
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      Divider()
        .margin({ top: 16 })
        .color('#F0F0F0')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 12 })
  }

  // ËèúÂìÅÈ°π
  @Builder
  buildDishItem(comboDish: ComboDish, index: number) {
    Row() {
      // ËèúÂìÅÂõæÁâá
      Image(comboDish.dish.image || 'common/images/default_dish.png')
        .width(60)
        .height(60)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.zwt'))
        .borderRadius(8)
        .margin({ right: 12 })

      // ËèúÂìÅ‰ø°ÊÅØ
      Column() {
        Text(comboDish.dish.name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .margin({ bottom: 4 })

        Row() {
          Text(`x${comboDish.quantity}`)
            .fontSize(12)
            .fontColor('#FF6B6B')
            .fontWeight(FontWeight.Medium)

          if (comboDish.isRequired) {
            Text('ÂøÖÈÄâ')
              .fontSize(10)
              .fontColor('#FF6B6B')
              .backgroundColor('#FFF0F0')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
    .padding({ top: 8, bottom: 8 })
    .backgroundColor(index % 2 === 0 ? '#FAFAFA' : Color.Transparent)
    .borderRadius(8)
    .margin({ bottom: 4 })
  }

  // Á¨¨ÂõõÈÉ®ÂàÜÔºöËØÑËÆ∫ÂàóË°®
  @Builder
  buildReviewList() {
    Column() {
      Row() {
        Text('Áî®Êà∑ËØÑ‰ª∑')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        if (this.combo) {
          Text(`${this.combo.reviewCount}Êù°ËØÑ‰ª∑`)
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .width('100%')
      .margin({ bottom: 16 })

      if (this.reviewStatus === LoadStatus.Loading) {
        Row() {
          LoadingProgress()
            .width(24)
            .height(24)
          Text(' Ê≠£Âú®Âä†ËΩΩËØÑËÆ∫...')
            .fontSize(14)
            .fontColor('#666666')
        }
        .width('100%')
        .height(100)
        .justifyContent(FlexAlign.Center)
      } else if (this.reviewStatus === LoadStatus.Error && this.reviewError) {
        Column() {
          Text(this.reviewError)
            .fontSize(14)
            .fontColor('#FF6B6B')
          Button('ÈáçËØï')
            .onClick(() => {
              if (this.combo) {
                this.loadReviews();
              }
            })
            .margin({ top: 8 })
        }
        .width('100%')
        .height(100)
        .justifyContent(FlexAlign.Center)
      } else if (this.reviews.length === 0) {
        Column() {
          Text('ÊöÇÊó†ËØÑ‰ª∑')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height(100)
        .justifyContent(FlexAlign.Center)
      } else {
        Column() {
          ForEach(this.reviews, (review: Review) => {
            this.buildReviewItem(review)
          })

          if (this.hasMoreReviews) {
            Row() {
              if (this.isLoadingMoreReviews) {
                LoadingProgress().width(20).height(20)
                Text(' Ê≠£Âú®Âä†ËΩΩÊõ¥Â§ö...').fontSize(12).fontColor('#666666')
              } else {
                Button('Âä†ËΩΩÊõ¥Â§öËØÑËÆ∫')
                  .fontSize(12)
                  .onClick(() => this.onLoadMoreReviews())
              }
            }
            .width('100%')
            .height(48)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .alignItems(HorizontalAlign.Start)
  }

  // ËØÑËÆ∫È°π
  @Builder
  buildReviewItem(review: Review) {
    Column() {
      Row() {
        Image(review.userAvatar || 'common/images/default_avatar.png')
          .width(40)
          .height(40)
          .borderRadius(20)
          .margin({ right: 12 })

        Column() {
          Text(review.userName)
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 4 })

          Row() {
            ForEach(Array.from({ length: review.rating }), () => {
              Text('‚òÖ')
                .fontSize(12)
                .fontColor('#FFC107')
            })
            ForEach(Array.from({ length: 5 - review.rating }), () => {
              Text('‚òÜ')
                .fontSize(12)
                .fontColor('#E0E0E0')
            })
          }
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Text(this.formatTime(review.createTime))
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      Text(review.content)
        .fontSize(14)
        .fontColor('#666666')
        .lineHeight(20)
        .margin({ top: 12, bottom: 8 })

      if (review.images && review.images.length > 0) {
        Row() {
          ForEach(review.images, (image: string) => {
            Image(image)
              .width(80)
              .height(80)
              .objectFit(ImageFit.Cover)
              .borderRadius(4)
              .margin({ right: 8 })
          })
        }
        .margin({ bottom: 8 })
      }

      Row() {
        Text(`üëç ${review.likes}`)
          .fontSize(12)
          .fontColor('#999999')
      }

      Divider()
        .margin({ top: 12, bottom: 12 })
        .color('#F0F0F0')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // Ê†ºÂºèÂåñÊó∂Èó¥
  private formatTime(timestamp: number): string {
    const now = Date.now();
    const diff = now - timestamp;
    const days = Math.floor(diff / 86400000);
    
    if (days === 0) {
      return '‰ªäÂ§©';
    } else if (days === 1) {
      return 'Êò®Â§©';
    } else if (days < 7) {
      return `${days}Â§©Ââç`;
    } else {
      const date = new Date(timestamp);
      return `${date.getMonth() + 1}-${date.getDate()}`;
    }
  }
}

